//peerjs-groups v1.0.0 by Elizabeth Hudnott

const ESCAPE_MAP=Object.freeze({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function escapeHTML(e){"use strict";return void 0!==e?String(e).replace(/[&<>"']/g,function(e){return ESCAPE_MAP[e]}):e}class PeerGroupEvent extends Event{constructor(e,t,s){super(e),Object.assign(this,s),this.administrator=t}}class PeerGroup extends EventTarget{constructor(e,t){var s;super();var n,r,o=new Map,i=new Map,a=new Set,c=new Map,d=new Map,u=new Set,l=new Set,v=!1,p=!1;const f=this,I=Object.freeze({DATA:1,IDENTIFY:2,PEER_LIST:3,PRIVATE_MSG:4,CONNECT_ERROR:5}),E=Object.freeze({DUPLICATE_USER_ID:1,PROHIBITED:2});function h(e,t){return{type:e,data:t}}function T(e,t){var s=n.id===r&&void 0!==r;return new PeerGroupEvent(e,s,t)}function D(t){if(!e)throw t;e(t)}function P(e){r=e;var t=T("connected",{sessionID:e,userID:escapeHTML(s),isPrivate:!0});f.dispatchEvent(t)}function g(){v=!0;var e=T("joined",{sessionID:r,userID:escapeHTML(s),isPrivate:!1});f.dispatchEvent(e)}function b(e){e.send(h(I.IDENTIFY,s))}function M(e){var t,o,i;switch(e.type){case I.PEER_LIST:if(this.peer===r)for(const t of e.data)t!==n.id&&A(t);break;case I.IDENTIFY:var u=e.data,l=escapeHTML(u);c.set(this.peer,u),d.set(l,this.peer),a.delete(this.peer),t=T("userpresent",{sessionID:r,userID:l,isPrivate:!1}),f.dispatchEvent(t),v||0!==a.size||g();break;case I.CONNECT_ERROR:t=T("ejected",{sessionID:r,userID:s,errorType:e.errorType,message:e.data,isPrivate:e.errorType===E.PROHIBITED&&void 0}),f.dispatchEvent(t);break;case I.DATA:case I.PRIVATE_MSG:t=T("message",{sessionID:r,userID:escapeHTML((o=this,i=o.label,i===s?c.get(o.peer):i)),message:e.data,isPrivate:e.type===I.PRIVATE_MSG}),f.dispatchEvent(t)}}function R(){var e,t,n=this.label,i=this.peer;e=n===s?c.get(i):n,o.delete(i),void 0!==e&&(t=T("userleft",{sessionID:r,userID:escapeHTML(e),isPrivate:!1}),f.dispatchEvent(t))}function L(){for(const e of o.values())e.off("close",R),e.close();void 0!==n&&n.destroy(),c.clear(),d.clear(),a.clear(),u.clear(),l.clear()}function A(e){a.add(e);var t=n.connect(e,{label:s,metadata:{sessionID:r},reliable:!0});t.on("data",M),t.on("error",function(e){a.delete(this.peer),D(e)}),t.on("open",function(){o.set(e,t)}),t.on("close",R)}function S(e,t,s){var n=h(I.CONNECT_ERROR,s);n.errorType=t,e.send(n),setTimeout(function(){e.close()},2e3)}function y(){void 0!==n&&n.destroy(),(n=new Peer(r,t)).on("error",function(e){"unavailable-id"===e.type?f.connect(r):D(e)}),n.on("open",function(){P(n.id),g()}),n.on("connection",function(t){t.on("open",function(){var n=t.label;if(l.has(n))S(t,E.PROHIBITED,`You've been banned from the session "${r}".`);else{var a=d.get(n);if(n===s||o.has(a)||i.has(a))S(t,E.DUPLICATE_USER_ID,`User ID "${n}" is already taken.`);else{var v=t.peer,I=c.get(v);if(void 0!==I&&d.delete(I),c.set(v,n),d.set(escapeHTML(n),v),i.set(v,t),t.on("error",e),u.has(n)||!p)f.acceptUser(n);else{t.on("close",function(){i.delete(this.peer),c.delete(this.peer),d.delete(escapeHTML(this.label))});var h=T("joinrequest",{sessionID:r,userID:escapeHTML(t.label),isPrivate:!0});f.dispatchEvent(h)}}}})})}this.connect=function(i,a){var u;L(),s=a,v=!1,void 0===(r=i)?y():PeerGroup.validSessionID.test(i)?((n=new Peer(t)).on("error",function(e){"peer-unavailable"===e.type?e.message.slice(-r.length)===r&&y():D(e)}),n.on("open",function(){(u=n.connect(r,{label:s,reliable:!0})).on("data",M),u.on("error",e),u.on("close",R),u.on("open",function(){o.set(r,this),P(r)})}),n.on("connection",function(t){t.on("open",function(){if(t.metadata.sessionID===r){var s=t.label,n=t.peer,i=c.get(n);void 0!==i&&d.delete(i),c.set(n,s),d.set(escapeHTML(s),n),o.set(n,t),b(t),t.on("data",M),t.on("error",e),t.on("close",R);var a=T("userpresent",{sessionID:r,userID:escapeHTML(s),isPrivate:!1});f.dispatchEvent(a)}else t.close()})})):D(new Error("Invalid session ID."))},this.disconnect=function(){L()},this.acceptUser=function(e){u.add(e);var t=d.get(e),s=i.get(t);if(void 0!==s){i.delete(t),o.set(t,s),s.on("data",M),s.on("close",R),s.send(h(I.PEER_LIST,Array.from(o.keys()))),b(s);var n=T("userpresent",{sessionID:r,userID:e,isPrivate:!1});f.dispatchEvent(n)}},this.rejectUser=function(e){l.add(e);var t=d.get(e);c.delete(t),d.delete(e);var s=i.get(t);void 0===s&&(s=o.get(t)),void 0!==s&&S(s,E.PROHIBITED,`You've been banned from the session "${r}".`)},this.send=function(e){!function(e){for(const t of o.values())t.send(e)}(h(I.DATA,e))},this.sendPrivate=function(e,t){var s=d.get(e);if(void 0===s){D(new Error(`No such user ${e}`))}else{var n=o.get(s);void 0===n&&(n=i.get(s)),n.send(h(I.PRIVATE_MSG,t))}},Object.defineProperty(this,"userIDs",{enumerable:!0,get(){let e=new Set;e.add(escapeHTML(s));for(let t of o.keys())e.add(escapeHTML(c.get(t)));return e}}),this.addEventListener=function(e,t,s){"joinrequest"===e&&(p=!0),PeerGroup.prototype.addEventListener.call(this,e,t,s)}}static get validSessionID(){return/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/}}